# Socure Flutter Plugin

A Flutter plugin for integrating Socure DocV SDK - Document Verification and KYC for Android and iOS platforms.

[![pub package](https://img.shields.io/pub/v/socure_flutter.svg)](https://pub.dev/packages/socure_flutter)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

## Features

- **Document Verification**: Capture and verify government-issued documents (ID cards, passports, driver's licenses)
- **KYC Compliance**: Complete Know Your Customer (KYC) verification flows
- **Cross-Platform**: Single Flutter API for both Android and iOS
- **Secure Token-Based Authentication**: Backend-generated transaction tokens for enhanced security
- **Rich Error Handling**: Comprehensive error types with user-friendly messages
- **Type-Safe Results**: Sealed result types with pattern matching support

## Supported Platforms

| Platform | Minimum Version | SDK Version |
|----------|----------------|-------------|
| **Android** | API 24 (Android 7.0) | DocV 5.2.7 |
| **iOS** | iOS 13.0+ | DocV 5.2.7 |

## Requirements

### Android
- Android SDK 24+
- Kotlin 1.9+
- Java 17+
- Gradle 8.1.4+

### iOS
- iOS 13.0+
- Xcode 14.1+
- Swift 5.0+
- CocoaPods or Swift Package Manager

## Installation

Add this to your package's `pubspec.yaml` file:

```yaml
dependencies:
  socure_flutter: ^0.0.1
```

Then run:

```bash
flutter pub get
```

### Android Setup

1. **Add Maven Repository**: No additional repository configuration needed (already included in the plugin).

2. **Permissions**: The plugin automatically includes required permissions. Your app will need to request camera permissions at runtime:

```xml
<!-- Already included in plugin AndroidManifest.xml -->
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

3. **Minimum SDK**: Ensure your `android/app/build.gradle` has `minSdkVersion` >= 24:

```gradle
android {
    defaultConfig {
        minSdkVersion 24
    }
}
```

### iOS Setup

1. **Add permissions to Info.plist**: Add camera and photo library usage descriptions:

```xml
<key>NSCameraUsageDescription</key>
<string>Camera access is required to capture documents for verification</string>
<key>NSPhotoLibraryUsageDescription</key>
<string>Photo library access allows you to select documents for verification</string>
```

2. **CocoaPods Installation**: Run `pod install` in your `ios/` directory:

```bash
cd ios && pod install && cd ..
```

## Usage

### 1. Get Transaction Token from Backend

**IMPORTANT**: Transaction tokens must be generated by your backend server using Socure's API. Never expose your SDK secret key in your mobile app.

Backend example (Node.js):

```javascript
const axios = require('axios');

async function generateTransactionToken(userId) {
  const response = await axios.post(
    'https://service.socure.com/api/3.0/EmailAuthScore',
    {
      modules: ['docv'],
      // ... other parameters
    },
    {
      headers: {
        'Authorization': `SocureApiKey ${YOUR_SECRET_KEY}`,
        'Content-Type': 'application/json'
      }
    }
  );

  return response.data.docvTransactionToken;
}
```

### 2. Launch DocV in Flutter

```dart
import 'package:socure_flutter/socure_flutter.dart';

class DocumentVerificationScreen extends StatefulWidget {
  @override
  _DocumentVerificationScreenState createState() =>
      _DocumentVerificationScreenState();
}

class _DocumentVerificationScreenState
    extends State<DocumentVerificationScreen> {
  final _socure = SocureFlutter();
  String _status = 'Ready to verify';
  bool _isLoading = false;

  Future<void> _launchDocV() async {
    setState(() {
      _isLoading = true;
      _status = 'Launching document verification...';
    });

    try {
      // 1. Get transaction token from your backend
      final token = await _getTransactionTokenFromBackend();

      // 2. Configure Socure options
      final options = SocureDocVOptions(
        sdkKey: 'YOUR_PUBLIC_SDK_KEY', // Your public key from Socure dashboard
        transactionToken: token,
        useSocureGov: false, // Set to true for government cloud
      );

      // 3. Launch DocV
      final result = await _socure.launchDocV(options);

      // 4. Handle result
      result.when(
        success: (data) {
          setState(() {
            _status = 'Verification successful!';
            _isLoading = false;
          });

          // Send device session token to your backend
          _sendTokenToBackend(data.deviceSessionToken);

          // Show success message
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Document verified successfully!'),
              backgroundColor: Colors.green,
            ),
          );
        },
        failure: (error) {
          setState(() {
            _status = 'Verification failed: ${error.userFriendlyMessage}';
            _isLoading = false;
          });

          // Handle specific error types
          if (error.errorType == SocureDocVErrorType.userCanceled) {
            // User canceled - maybe show a different message
            print('User canceled verification');
          } else if (error.errorType ==
              SocureDocVErrorType.cameraPermissionDenied) {
            // Show permission settings dialog
            _showPermissionDialog();
          }

          // Show error message
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(error.userFriendlyMessage),
              backgroundColor: Colors.red,
            ),
          );
        },
      );
    } catch (e) {
      setState(() {
        _status = 'Error: $e';
        _isLoading = false;
      });
    }
  }

  Future<String> _getTransactionTokenFromBackend() async {
    // TODO: Call your backend API to generate transaction token
    // This is just a placeholder - implement your actual API call
    final response = await http.post(
      Uri.parse('https://your-backend.com/api/generate-token'),
      headers: {'Authorization': 'Bearer ${userAuthToken}'},
    );

    if (response.statusCode == 200) {
      final data = json.decode(response.body);
      return data['transactionToken'];
    } else {
      throw Exception('Failed to get transaction token');
    }
  }

  Future<void> _sendTokenToBackend(String deviceSessionToken) async {
    // TODO: Send the device session token to your backend
    // Your backend will use this to fetch verification results from Socure
    await http.post(
      Uri.parse('https://your-backend.com/api/verify-document'),
      headers: {'Content-Type': 'application/json'},
      body: json.encode({'deviceSessionToken': deviceSessionToken}),
    );
  }

  void _showPermissionDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Camera Permission Required'),
        content: Text(
          'Camera access is required for document verification. '
          'Please grant camera permission in Settings.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancel'),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context);
              // Open app settings (you'll need a package like permission_handler)
              // openAppSettings();
            },
            child: Text('Open Settings'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Document Verification'),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.badge,
              size: 100,
              color: Colors.blue,
            ),
            SizedBox(height: 24),
            Text(
              _status,
              textAlign: TextAlign.center,
              style: TextStyle(fontSize: 16),
            ),
            SizedBox(height: 32),
            ElevatedButton(
              onPressed: _isLoading ? null : _launchDocV,
              child: _isLoading
                  ? CircularProgressIndicator(color: Colors.white)
                  : Text('Start Verification'),
            ),
          ],
        ),
      ),
    );
  }
}
```

## API Reference

### SocureFlutter

Main class for interacting with Socure DocV SDK.

#### Methods

##### `launchDocV(SocureDocVOptions options) â†’ Future<SocureDocVResult>`

Launches the Socure DocV SDK for document verification.

**Parameters:**
- `options` (SocureDocVOptions): Configuration options

**Returns:**
- `Future<SocureDocVResult>`: Result object (success or failure)

### SocureDocVOptions

Configuration options for launching DocV.

```dart
SocureDocVOptions({
  required String sdkKey,           // Your public SDK key
  required String transactionToken, // Token from backend
  bool useSocureGov = false,       // Use government cloud (optional)
})
```

### SocureDocVResult

Sealed result type that can be either `SocureDocVSuccess` or `SocureDocVFailure`.

**Properties:**
- `isSuccess` (bool): True if result is success
- `isFailure` (bool): True if result is failure
- `success` (SocureDocVSuccess?): Success data (null if failure)
- `failure` (SocureDocVFailure?): Failure data (null if success)

**Methods:**
- `when<T>({required success, required failure})`: Pattern matching

### SocureDocVSuccess

Success result containing device session token.

```dart
SocureDocVSuccess({
  required String deviceSessionToken, // Token to send to backend
})
```

### SocureDocVFailure

Failure result containing error information.

```dart
SocureDocVFailure({
  required SocureDocVErrorType errorType,  // Error type enum
  required String errorMessage,            // Detailed error message
  String? deviceSessionToken,             // Optional session token
})
```

**Properties:**
- `userFriendlyMessage` (String): User-friendly error message

### SocureDocVErrorType

Error types enum:

- `invalidKey`: Invalid SDK key
- `userCanceled`: User canceled verification
- `networkError`: Network/internet error
- `cameraPermissionDenied`: Camera permission denied
- `cameraError`: Camera initialization error
- `invalidToken`: Invalid/expired transaction token
- `serverError`: Server/API error
- `initializationError`: SDK initialization failed
- `captureError`: Document capture failed
- `unknown`: Unknown error

## Error Handling

The plugin provides comprehensive error handling with type-safe error types:

```dart
final result = await socure.launchDocV(options);

if (result.isFailure) {
  final error = result.failure!;

  switch (error.errorType) {
    case SocureDocVErrorType.userCanceled:
      // Handle user cancellation
      print('User canceled');
      break;

    case SocureDocVErrorType.cameraPermissionDenied:
      // Prompt user to enable camera permission
      showPermissionDialog();
      break;

    case SocureDocVErrorType.networkError:
      // Show retry option
      showRetryDialog();
      break;

    case SocureDocVErrorType.invalidToken:
      // Token expired, get a new one
      refreshToken();
      break;

    default:
      // Show generic error
      showError(error.userFriendlyMessage);
  }
}
```

## Backend Integration

### 1. Generate Transaction Token

Your backend should call Socure's API to generate a transaction token:

```
POST https://service.socure.com/api/3.0/EmailAuthScore
Authorization: SocureApiKey YOUR_SECRET_KEY
Content-Type: application/json

{
  "modules": ["docv"],
  "firstName": "John",
  "surName": "Doe",
  "email": "john@example.com"
}
```

### 2. Receive Device Session Token

After successful verification, your mobile app sends the device session token to your backend.

### 3. Fetch Verification Results

Your backend uses the device session token to fetch complete verification results from Socure's ID+ API:

```
GET https://service.socure.com/api/3.0/EmailAuthScore/{referenceId}
Authorization: SocureApiKey YOUR_SECRET_KEY
```

## Testing

For testing without a backend, you can use Socure's sandbox environment. Contact Socure support for sandbox credentials.

## Troubleshooting

### Android Issues

**Issue:** `com.socure.idplus.docv not found`
**Solution:** Ensure you've added the Socure Maven repository and synced Gradle.

**Issue:** Camera permission denied
**Solution:** Request camera permission at runtime using `permission_handler` package.

### iOS Issues

**Issue:** `Module 'SocureDocV' not found`
**Solution:** Run `cd ios && pod install && cd ..`

**Issue:** App crashes on iOS 13
**Solution:** Ensure minimum deployment target is iOS 13.0 in `ios/Podfile`:
```ruby
platform :ios, '13.0'
```

## Security Best Practices

1. **Never embed secret keys** in your mobile app - always use backend-generated transaction tokens
2. **Validate tokens server-side** before generating them
3. **Use HTTPS** for all backend communication
4. **Implement token expiration** handling
5. **Store SDK keys securely** in environment variables on your backend

## Example App

See the [`example`](example/) directory for a complete working example application.

To run the example:

```bash
cd example
flutter run
```

## Additional Resources

- [Socure DocV Documentation](https://developer.socure.com/docs/docv-overview)
- [Socure Dashboard](https://dashboard.socure.com/)
- [API Documentation](https://developer.socure.com/)

## Support

For issues or questions:

- **Plugin Issues**: Open an issue on [GitHub](https://github.com/yourrepo/socure_flutter/issues)
- **Socure SDK Issues**: Contact [Socure Support](https://support.socure.com)

## License

This plugin is licensed under the MIT License. See [LICENSE](LICENSE) file for details.

Note: Socure DocV SDK has its own licensing terms. Contact Socure for commercial licensing.
